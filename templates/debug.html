<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Console</title>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #000000;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: #1a1a1a;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(255, 255, 255, 0.1);
            padding: 30px;
        }

        h1 {
            color: #ffffff;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #aaaaaa;
            margin-bottom: 30px;
        }

        .navigation {
            display: flex;
            gap: 0;
            margin-bottom: 30px;
            border-bottom: 2px solid #333333;
        }

        .nav-link {
            padding: 12px 24px;
            text-decoration: none;
            color: #aaaaaa;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            font-weight: 500;
        }

        .nav-link:hover {
            color: #ffffff;
            background: #2a2a2a;
        }

        .nav-link.active {
            color: #ffffff;
            border-bottom-color: #2196F3;
        }

        .nav-link.view-kiosk {
            margin-left: auto;
            color: #4CAF50;
        }

        .nav-link.view-kiosk:hover {
            color: #66BB6A;
            background: transparent;
        }

        .debug-panel {
            background: #2a2a2a;
            border: 2px solid #444444;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .debug-panel h2 {
            color: #ffffff;
            margin-bottom: 15px;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .debug-console {
            background: #263238;
            color: #aed581;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            padding: 15px;
            border-radius: 4px;
            height: 800px;
            overflow-y: auto;
            margin-top: 10px;
        }

        .debug-console-line {
            margin-bottom: 4px;
            word-wrap: break-word;
        }

        .debug-console-line.error {
            color: #ef5350;
        }

        .debug-console-line.info {
            color: #81c784;
        }

        .debug-timestamp {
            color: #78909c;
            margin-right: 8px;
        }

        .debug-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .debug-button {
            background: #757575;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
        }

        .debug-button:hover {
            background: #616161;
        }

        .message {
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 20px;
            display: none;
        }

        .message.success {
            background: #1b5e20;
            color: #a5d6a7;
            border: 1px solid #4caf50;
        }

        .message.error {
            background: #b71c1c;
            color: #ef9a9a;
            border: 1px solid #f44336;
        }

        .message.visible {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Debug Console</h1>

        <div class="navigation">
            <a href="/remote" class="nav-link">Remote</a>
            <a href="/" class="nav-link">Manage</a>
            <a href="/upload" class="nav-link">Upload</a>
            <a href="/search" class="nav-link">Search Art</a>
            <a href="/extra-images" class="nav-link">Extra Images</a>
            <a href="/debug" class="nav-link active">Debug</a>
            <a href="/view?fit=true" class="nav-link view-kiosk" target="_blank">View Kiosk Display</a>
        </div>

        <div id="message" class="message"></div>

        <div class="debug-panel">
            <h2>üêõ Debug Console - Kiosk Display Logs</h2>
            <div class="debug-console" id="debug-console">
                <div class="debug-console-line">Loading debug messages...</div>
            </div>
            <div class="debug-controls">
                <button class="debug-button" onclick="clearDebugConsole()">Clear Console</button>
                <button class="debug-button" onclick="clipDebugConsole()">üìã Clip</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        // Initialize Socket.IO connection
        const socket = io();

        // Refresh debug console with latest messages
        async function refreshDebugConsole() {
            try {
                const response = await fetch('/api/debug/messages');
                const messages = await response.json();

                const console = document.getElementById('debug-console');
                console.innerHTML = '';

                if (messages.length === 0) {
                    console.innerHTML = '<div class="debug-console-line">No debug messages yet. Waiting for kiosk activity...</div>';
                    return;
                }

                messages.forEach(msg => {
                    const line = document.createElement('div');
                    line.className = `debug-console-line ${msg.level}`;

                    const timestamp = new Date(msg.timestamp * 1000).toLocaleTimeString();
                    const timestampSpan = document.createElement('span');
                    timestampSpan.className = 'debug-timestamp';
                    timestampSpan.textContent = `[${timestamp}]`;

                    line.appendChild(timestampSpan);
                    line.appendChild(document.createTextNode(msg.message));

                    console.appendChild(line);
                });

                // Auto-scroll to bottom
                console.scrollTop = console.scrollHeight;
            } catch (error) {
                console.error('Error fetching debug messages:', error);
            }
        }

        // Clear debug console
        async function clearDebugConsole() {
            try {
                await fetch('/api/debug/clear', { method: 'POST' });
                const console = document.getElementById('debug-console');
                console.innerHTML = '<div class="debug-console-line">Console cleared.</div>';
            } catch (error) {
                console.error('Error clearing debug console:', error);
            }
        }

        // Copy debug console to clipboard
        async function clipDebugConsole() {
            const button = event.target;

            try {
                const consoleEl = document.getElementById('debug-console');
                const lines = consoleEl.querySelectorAll('.debug-console-line');

                // Extract text from all lines
                const text = Array.from(lines).map(line => line.textContent).join('\n');

                // Try modern clipboard API first, fallback to textarea method
                let success = false;

                if (navigator.clipboard && navigator.clipboard.writeText) {
                    try {
                        await navigator.clipboard.writeText(text);
                        success = true;
                    } catch (e) {
                        // Clipboard API failed, use fallback
                        console.log('Clipboard API failed, using fallback');
                    }
                }

                // Fallback method using textarea (works on HTTP)
                if (!success) {
                    const textarea = document.createElement('textarea');
                    textarea.value = text;
                    textarea.style.position = 'fixed';
                    textarea.style.opacity = '0';
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                    success = true;
                }

                // Visual feedback - change button appearance
                button.style.background = '#4CAF50';
                button.textContent = '‚úì Copied!';

                setTimeout(() => {
                    button.style.background = '';
                    button.textContent = 'üìã Clip';
                }, 1500);

                // Show feedback message
                showMessage('Debug log copied to clipboard', 'success');
            } catch (error) {
                console.error('Error copying to clipboard:', error);

                // Visual feedback for error
                button.style.background = '#f44336';
                button.textContent = '‚úó Failed';

                setTimeout(() => {
                    button.style.background = '';
                    button.textContent = 'üìã Clip';
                }, 1500);

                showMessage('Failed to copy to clipboard: ' + error.message, 'error');
            }
        }

        // Append a single debug message to the console
        function appendDebugMessage(msg) {
            const consoleEl = document.getElementById('debug-console');

            // Clear placeholder text if this is the first message
            if (consoleEl.textContent.includes('No debug messages yet')) {
                consoleEl.innerHTML = '';
            }

            const line = document.createElement('div');
            line.className = `debug-console-line ${msg.level}`;

            const timestamp = new Date(msg.timestamp * 1000).toLocaleTimeString();
            const timestampSpan = document.createElement('span');
            timestampSpan.className = 'debug-timestamp';
            timestampSpan.textContent = `[${timestamp}]`;

            line.appendChild(timestampSpan);
            line.appendChild(document.createTextNode(msg.message));

            consoleEl.appendChild(line);

            // Auto-scroll to bottom
            consoleEl.scrollTop = consoleEl.scrollHeight;
        }

        // Show message
        function showMessage(text, type) {
            const message = document.getElementById('message');
            message.textContent = text;
            message.className = `message ${type} visible`;

            setTimeout(() => {
                message.classList.remove('visible');
            }, 3000);
        }

        // WebSocket event handlers for real-time updates
        socket.on('connect', () => {
            console.log('WebSocket connected');
        });

        socket.on('disconnect', () => {
            console.log('WebSocket disconnected');
        });

        socket.on('reconnect', () => {
            console.log('WebSocket reconnected');
            // Reload debug messages after reconnection
            refreshDebugConsole();
        });

        socket.on('debug_message', (msg) => {
            appendDebugMessage(msg);
        });

        // Load debug messages on page load
        refreshDebugConsole();
    </script>
</body>
</html>
