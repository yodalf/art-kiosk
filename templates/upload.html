<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Images</title>

    <!-- Cropper.js CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
        }

        .section {
            margin-bottom: 40px;
        }

        .section h2 {
            color: #444;
            margin-bottom: 15px;
            font-size: 18px;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
        }

        .upload-area {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            background: #fafafa;
            transition: all 0.3s;
            cursor: pointer;
        }

        .upload-area:hover {
            border-color: #4CAF50;
            background: #f0f8f0;
        }

        .upload-area.dragging {
            border-color: #4CAF50;
            background: #e8f5e9;
        }

        .upload-button {
            background: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
        }

        .upload-button:hover {
            background: #45a049;
        }

        #file-input {
            display: none;
        }

        .message {
            padding: 12px 20px;
            margin-bottom: 20px;
            border-radius: 4px;
            display: none;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }

        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .image-card {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: visible;
            background: white;
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
        }

        .image-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .image-card img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            display: block;
            border-radius: 8px 8px 0 0;
            overflow: hidden;
        }

        .card-info {
            padding: 12px;
        }

        .image-name {
            font-weight: 500;
            color: #333;
            margin-bottom: 5px;
            word-break: break-word;
        }

        .image-size {
            color: #999;
            font-size: 12px;
        }

        /* Action menu styles */
        .action-menu-container {
            position: relative;
        }

        .action-menu-button {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 18px;
            line-height: 1;
            color: #666;
            z-index: 10;
        }

        .action-menu-button:hover {
            background: white;
            color: #333;
        }

        .action-menu-dropdown {
            position: absolute;
            bottom: 100%;
            right: 0;
            margin-bottom: 4px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            min-width: 180px;
            z-index: 1000;
            display: none;
        }

        .action-menu-dropdown.show {
            display: block;
        }

        .menu-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
        }

        .menu-item:last-child {
            border-bottom: none;
        }

        .menu-item:hover {
            background: #f5f5f5;
        }

        .menu-item-danger {
            color: #f44336;
        }

        .menu-item-danger:hover {
            background: #ffebee;
        }

        .menu-item.has-submenu {
            position: relative;
        }

        .submenu-arrow {
            float: right;
            margin-left: 10px;
        }

        .submenu {
            position: absolute;
            left: 100%;
            bottom: 0;
            margin-left: 4px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            min-width: 150px;
            display: none;
            z-index: 1001;
        }

        .submenu.show {
            display: block;
        }

        .submenu-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
        }

        .submenu-item:last-child {
            border-bottom: none;
        }

        .submenu-item:hover {
            background: #f5f5f5;
        }

        /* Crop modal styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 8px;
            padding: 20px;
            max-width: 90%;
            max-height: 90%;
            overflow: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            margin: 0;
        }

        .close-button {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        .crop-container {
            max-width: 800px;
            max-height: 600px;
            margin-bottom: 20px;
        }

        .crop-container img {
            max-width: 100%;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .modal-button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .modal-button.primary {
            background: #4CAF50;
            color: white;
        }

        .modal-button.primary:hover {
            background: #45a049;
        }

        .modal-button.secondary {
            background: #f5f5f5;
            color: #333;
        }

        .modal-button.secondary:hover {
            background: #e0e0e0;
        }

        .modal-button.danger {
            background: #f44336;
            color: white;
        }

        .modal-button.danger:hover {
            background: #d32f2f;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Upload Images</h1>
        <p class="subtitle">Upload images for your kiosk display</p>

        <div id="message" class="message"></div>

        <div class="section">
            <h2>Upload Images</h2>
            <div class="upload-area" id="upload-area" onclick="document.getElementById('file-input').click()">
                <p style="font-size: 18px; color: #666; margin-bottom: 10px;">
                    Drag and drop images here or click to select
                </p>
                <p style="font-size: 14px; color: #999;">
                    Supported formats: PNG, JPG, JPEG, GIF, WebP, BMP
                </p>
                <input type="file" id="file-input" accept="image/*" multiple>
                <button class="upload-button" onclick="event.stopPropagation(); document.getElementById('file-input').click()">
                    Choose Files
                </button>
            </div>
        </div>

        <div class="section">
            <h2>All Images</h2>
            <div class="image-grid" id="image-grid">
                <p style="color: #999;">Loading images...</p>
            </div>
        </div>
    </div>

    <!-- Crop Modal -->
    <div id="crop-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Crop Image</h2>
                <button class="close-button" onclick="closeCropModal()">&times;</button>
            </div>
            <div class="crop-container">
                <img id="crop-image" src="" alt="Image to crop">
            </div>
            <div class="modal-actions">
                <button class="modal-button danger" onclick="clearCrop()">Clear Crop</button>
                <button class="modal-button secondary" onclick="closeCropModal()">Cancel</button>
                <button class="modal-button primary" onclick="saveCrop()">Save Crop</button>
            </div>
        </div>
    </div>

    <!-- Cropper.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>

    <script>
        // Menu handling functions
        function toggleMenu(menuContainer) {
            const dropdown = menuContainer.querySelector('.action-menu-dropdown');
            const isOpen = dropdown.classList.contains('show');

            closeAllMenus();

            if (!isOpen) {
                dropdown.classList.add('show');
                const card = menuContainer.closest('.image-card');
                if (card) {
                    card.style.zIndex = '1002';
                }
            }
        }

        function closeAllMenus() {
            document.querySelectorAll('.action-menu-dropdown.show').forEach(dropdown => {
                dropdown.classList.remove('show');
                const card = dropdown.closest('.image-card');
                if (card) {
                    card.style.zIndex = '';
                }
            });
        }

        document.addEventListener('click', function(e) {
            if (!e.target.closest('.action-menu-container')) {
                closeAllMenus();
            }
        });

        // Upload functionality
        const uploadArea = document.getElementById('upload-area');
        const fileInput = document.getElementById('file-input');

        function showMessage(text, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = text;
            messageDiv.className = `message ${type}`;
            setTimeout(() => {
                messageDiv.className = 'message';
            }, 3000);
        }

        // Drag and drop handlers
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragging');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragging');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragging');

            const files = e.dataTransfer.files;
            handleFiles(files);
        });

        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        async function handleFiles(files) {
            for (const file of files) {
                if (!file.type.startsWith('image/')) {
                    showMessage(`${file.name} is not an image`, 'error');
                    continue;
                }

                const formData = new FormData();
                formData.append('file', file);

                try {
                    const response = await fetch('/api/images', {
                        method: 'POST',
                        body: formData
                    });

                    if (response.ok) {
                        showMessage(`${file.name} uploaded successfully`, 'success');
                        await loadImages();
                    } else {
                        const error = await response.json();
                        showMessage(error.error || `Error uploading ${file.name}`, 'error');
                    }
                } catch (error) {
                    console.error('Upload error:', error);
                    showMessage(`Error uploading ${file.name}`, 'error');
                }
            }
            fileInput.value = '';
        }

        // Load and display images
        async function loadImages() {
            try {
                const response = await fetch('/api/images');
                const images = await response.json();

                const grid = document.getElementById('image-grid');
                grid.innerHTML = '';

                if (images.length === 0) {
                    grid.innerHTML = '<p style="color: #999;">No images uploaded yet</p>';
                    return;
                }

                images.forEach(image => {
                    const card = document.createElement('div');
                    card.className = 'image-card';

                    // Build theme submenu
                    let themeSubmenuHTML = '';
                    if (Object.keys(availableThemes).length > 0) {
                        themeSubmenuHTML = '<div class="menu-item has-submenu">Add to theme <span class="submenu-arrow">▸</span><div class="submenu">';
                        for (const themeName in availableThemes) {
                            if (!(image.themes || []).includes(themeName)) {
                                themeSubmenuHTML += `<div class="submenu-item" data-theme="${themeName}" data-image="${image.name}">${themeName}</div>`;
                            }
                        }
                        themeSubmenuHTML += '</div></div>';
                    }

                    card.innerHTML = `
                        <div class="action-menu-container">
                            <button class="action-menu-button">⋮</button>
                            <div class="action-menu-dropdown">
                                ${themeSubmenuHTML}
                                <div class="menu-item" data-action="crop" data-image="${image.name}" data-url="${image.url}">Crop</div>
                                <div class="menu-item menu-item-danger" data-action="delete" data-image="${image.name}">Delete</div>
                            </div>
                        </div>
                        <img src="${image.url}" alt="${image.name}" loading="lazy">
                        <div class="card-info">
                            <div class="image-name">${image.name}</div>
                            <div class="image-size">${formatFileSize(image.size)}</div>
                        </div>
                    `;

                    // Add menu button click handler
                    const menuButton = card.querySelector('.action-menu-button');
                    const menuContainer = card.querySelector('.action-menu-container');
                    menuButton.addEventListener('click', (e) => {
                        e.stopPropagation();
                        toggleMenu(menuContainer);
                    });

                    // Add menu item handlers
                    const menuItems = card.querySelectorAll('.menu-item[data-action]');
                    menuItems.forEach(item => {
                        item.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const action = item.getAttribute('data-action');
                            const imageName = item.getAttribute('data-image');
                            closeAllMenus();

                            if (action === 'crop') {
                                const imageUrl = item.getAttribute('data-url');
                                openCropModal(imageName, imageUrl);
                            } else if (action === 'delete') {
                                deleteImage(imageName);
                            }
                        });
                    });

                    // Add theme submenu handlers
                    const themeMenuItem = card.querySelector('.menu-item.has-submenu');
                    if (themeMenuItem) {
                        const themeSubmenu = themeMenuItem.querySelector('.submenu');

                        themeMenuItem.addEventListener('mouseenter', () => {
                            themeSubmenu.classList.add('show');
                        });

                        themeMenuItem.addEventListener('mouseleave', () => {
                            setTimeout(() => {
                                if (!themeSubmenu.matches(':hover')) {
                                    themeSubmenu.classList.remove('show');
                                }
                            }, 100);
                        });

                        themeSubmenu.addEventListener('mouseleave', () => {
                            themeSubmenu.classList.remove('show');
                        });

                        const submenuItems = themeSubmenu.querySelectorAll('.submenu-item');
                        submenuItems.forEach(item => {
                            item.addEventListener('click', async (e) => {
                                e.stopPropagation();
                                const themeName = item.getAttribute('data-theme');
                                const imageName = item.getAttribute('data-image');
                                closeAllMenus();
                                await addImageToTheme(imageName, themeName);
                            });
                        });
                    }

                    grid.appendChild(card);
                });
            } catch (error) {
                console.error('Error loading images:', error);
                showMessage('Error loading images', 'error');
            }
        }

        async function deleteImage(filename) {
            if (!confirm(`Delete ${filename}?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/images/${encodeURIComponent(filename)}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showMessage(`${filename} deleted`, 'success');
                    await loadImages();
                } else {
                    showMessage('Error deleting image', 'error');
                }
            } catch (error) {
                console.error('Delete error:', error);
                showMessage('Error deleting image', 'error');
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        // Theme management
        let availableThemes = {};

        async function loadThemes() {
            try {
                const response = await fetch('/api/themes');
                const data = await response.json();
                availableThemes = data.themes;
            } catch (error) {
                console.error('Error loading themes:', error);
            }
        }

        async function addImageToTheme(imageName, themeName) {
            try {
                const response = await fetch('/api/images');
                const images = await response.json();
                const image = images.find(img => img.name === imageName);

                if (!image) return;

                const newThemes = [...(image.themes || []), themeName];

                const updateResponse = await fetch(`/api/images/${encodeURIComponent(imageName)}/themes`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ themes: newThemes })
                });

                if (updateResponse.ok) {
                    showMessage(`Added to theme "${themeName}"`, 'success');
                    await loadImages();
                } else {
                    showMessage('Error adding to theme', 'error');
                }
            } catch (error) {
                console.error('Error adding to theme:', error);
                showMessage('Error adding to theme', 'error');
            }
        }

        // Crop functionality
        let cropper = null;
        let currentCropImageName = null;

        function openCropModal(imageName, imageUrl) {
            currentCropImageName = imageName;
            const modal = document.getElementById('crop-modal');
            const img = document.getElementById('crop-image');

            img.src = imageUrl;
            modal.classList.add('show');

            // Initialize cropper when image loads
            img.onload = function() {
                if (cropper) {
                    cropper.destroy();
                }

                cropper = new Cropper(img, {
                    viewMode: 1,
                    dragMode: 'move',
                    aspectRatio: NaN,
                    autoCropArea: 1,
                    restore: false,
                    guides: true,
                    center: true,
                    highlight: false,
                    cropBoxMovable: true,
                    cropBoxResizable: true,
                    toggleDragModeOnDblclick: false,
                });

                // Load existing crop if available
                loadExistingCrop(imageName);
            };
        }

        function closeCropModal() {
            const modal = document.getElementById('crop-modal');
            modal.classList.remove('show');
            if (cropper) {
                cropper.destroy();
                cropper = null;
            }
            currentCropImageName = null;
        }

        async function loadExistingCrop(imageName) {
            try {
                const response = await fetch('/api/settings');
                const settings = await response.json();
                const cropData = settings.image_crops?.[imageName];

                if (cropData && cropper) {
                    const imageData = cropper.getImageData();
                    const scaleX = imageData.naturalWidth / cropData.imageWidth;
                    const scaleY = imageData.naturalHeight / cropData.imageHeight;

                    cropper.setData({
                        x: cropData.x * scaleX,
                        y: cropData.y * scaleY,
                        width: cropData.width * scaleX,
                        height: cropData.height * scaleY
                    });
                }
            } catch (error) {
                console.error('Error loading existing crop:', error);
            }
        }

        async function saveCrop() {
            if (!cropper || !currentCropImageName) return;

            const cropData = cropper.getData();
            const imageData = cropper.getImageData();

            const cropInfo = {
                x: Math.round(cropData.x),
                y: Math.round(cropData.y),
                width: Math.round(cropData.width),
                height: Math.round(cropData.height),
                imageWidth: imageData.naturalWidth,
                imageHeight: imageData.naturalHeight
            };

            try {
                const response = await fetch('/api/settings');
                const settings = await response.json();

                if (!settings.image_crops) {
                    settings.image_crops = {};
                }
                settings.image_crops[currentCropImageName] = cropInfo;

                const saveResponse = await fetch('/api/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });

                if (saveResponse.ok) {
                    showMessage('Crop saved', 'success');
                    closeCropModal();
                    await loadImages();
                } else {
                    showMessage('Error saving crop', 'error');
                }
            } catch (error) {
                console.error('Error saving crop:', error);
                showMessage('Error saving crop', 'error');
            }
        }

        async function clearCrop() {
            if (!currentCropImageName) return;

            if (!confirm('Clear crop for this image?')) {
                return;
            }

            try {
                const response = await fetch('/api/settings');
                const settings = await response.json();

                if (settings.image_crops && settings.image_crops[currentCropImageName]) {
                    delete settings.image_crops[currentCropImageName];

                    const saveResponse = await fetch('/api/settings', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(settings)
                    });

                    if (saveResponse.ok) {
                        showMessage('Crop cleared', 'success');
                        closeCropModal();
                        await loadImages();
                    } else {
                        showMessage('Error clearing crop', 'error');
                    }
                }
            } catch (error) {
                console.error('Error clearing crop:', error);
                showMessage('Error clearing crop', 'error');
            }
        }

        // Load themes and images on page load
        loadThemes().then(() => loadImages());
    </script>
</body>
</html>
